<script type="text/javascript" src="http://www.openlayers.org/api/OpenLayers.js"></script>
<script type="text/javascript" src="http://maps.stamen.com/js/tile.stamen.js?v1.2.0"></script>

<script type="text/javascript">
	var map, layer;

	function initialize() {

		map = new OpenLayers.Map("map");
        map.addLayer(layer = new OpenLayers.Layer.Stamen("watercolor"));
        map.setCenter(new OpenLayers.LonLat(1.3, 46.9).transform('EPSG:4326', 'EPSG:3857'), 6);

    /*
		var myOptions = {
			center: new google.maps.LatLng(46.9, 1.3),
			zoom: 6,
			mapTypeId: google.maps.MapTypeId.SATELLITE
		};
		var map = new google.maps.Map(document.getElementById("map"), myOptions);
		var snowflakes = Array();
		var infowindow = new google.maps.InfoWindow({
			content: "chargement..."
		});
		{% for snowflake in object_list %}
			flakesize = {{ snowflake.flakesize }};
			half_flakesize = {{ snowflake.flakesize }}/2;
			marker = new google.maps.Marker({
				position: new google.maps.LatLng({{snowflake.latitude}}, {{ snowflake.longitude}}),
				map: map,
				icon: new google.maps.MarkerImage('{{ STATIC_URL }}snowflake_icon.png',
					new google.maps.Size(flakesize, flakesize),
					new google.maps.Point(0,0),
					new google.maps.Point(half_flakesize, half_flakesize),
					new google.maps.Size(flakesize, flakesize)
				),
				title: "{{ snowflake.zipcode }}{% if snowflake.rank %} ({{ snowflake.rank }}/10){% endif %}"}
 			);
			snowflakes.push(marker);
	 		google.maps.event.addListener(marker, 'click', function () {
				infowindow.setContent("<img class='tweet_picture' src='{{ snowflake.tweet_object.profile_image_url }}' alt='Image {{ snowflake.tweet_object.from_user_name }}' /><div class='tweet_body'><a target='_blank' href='https://twitter.com/#!/{{ snowflake.tweet_object.from_user }}/status/{{ snowflake.tweet_id }}'>@{{ snowflake.tweet_object.from_user_name }}</a><br>{{ snowflake.tweet_object.text }}</div>");
				infowindow.open(map, this);
			});
		{% endfor %}
	*/

			var layer = new OpenLayers.Layer.Vector("POIs", {
                    strategies: [new OpenLayers.Strategy.BBOX({resFactor: 1.1})],
                    protocol: new OpenLayers.Protocol.HTTP({
                        url: '{% url textfile %}',
                        format: new OpenLayers.Format.Text()
                    })
                });

                map.addLayers([layer]);

                // Interaction; not needed for initial display.
                selectControl = new OpenLayers.Control.SelectFeature(layer);
                map.addControl(selectControl);
                selectControl.activate();
                layer.events.on({
                    'featureselected': onFeatureSelect,
                    'featureunselected': onFeatureUnselect
                });
            }


            // Needed only for interaction, not for the display.
            function onPopupClose(evt) {
                // 'this' is the popup.
                var feature = this.feature;
                if (feature.layer) { // The feature is not destroyed
                    selectControl.unselect(feature);
                } else { // After "moveend" or "refresh" events on POIs layer all
                         //     features have been destroyed by the Strategy.BBOX
                    this.destroy();
                }
            }
            function onFeatureSelect(evt) {
                feature = evt.feature;
                popup = new OpenLayers.Popup.FramedCloud("featurePopup",
                                         feature.geometry.getBounds().getCenterLonLat(),
                                         new OpenLayers.Size(100,100),
                                         "<h2>"+feature.attributes.title + "</h2>" +
                                         feature.attributes.description,
                                         null, true, onPopupClose);
                feature.popup = popup;
                popup.feature = feature;
                map.addPopup(popup, true);
            }
            function onFeatureUnselect(evt) {
                feature = evt.feature;
                if (feature.popup) {
                    popup.feature = null;
                    map.removePopup(feature.popup);
                    feature.popup.destroy();
                    feature.popup = null;
                }
            }
</script>


<script type="text/javascript">

var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-2980397-12']);
_gaq.push(['_setDomainName', 'neigefr.org']);
_gaq.push(['_setAllowLinker', true]);
_gaq.push(['_trackPageview']);

(function() {
var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})();

</script>
